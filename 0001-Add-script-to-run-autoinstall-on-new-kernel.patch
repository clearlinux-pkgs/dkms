From 46aa6b6523a3b087912e26cc4d68aae9ae10c0a0 Mon Sep 17 00:00:00 2001
From: "Brett T. Warden" <brett.t.warden@intel.com>
Date: Tue, 15 Jan 2019 14:58:11 -0800
Subject: [PATCH] Add script to run autoinstall on new kernel

---
 dkms-new-kernel.sh | 20 ++++++++++++++++++++
 1 file changed, 20 insertions(+)
 create mode 100755 dkms-new-kernel.sh

diff --git a/dkms-new-kernel.sh b/dkms-new-kernel.sh
new file mode 100755
index 000000000000..23f6a96df8a5
--- /dev/null
+++ b/dkms-new-kernel.sh
@@ -0,0 +1,20 @@
+#!/bin/sh
+
+CUR="`uname -r`"
+SUF="`uname -r| sed 's/.*[.]//'`"
+DEF="/usr/lib/kernel/default-$SUF"
+
+if [ ! -e $DEF ]; then
+	exit 0
+fi
+
+NEW="`readlink $DEF | sed 's/org.clearlinux.\([a-z][a-z0-9_-]*\).\(.*\)/\2.\1/'`"
+
+if [ "$CUR" != "$NEW" ]; then
+	echo "Running DKMS for new kernel $NEW"
+	dkms autoinstall -k "${NEW}"
+else
+	echo "Refreshing modules.dep and map files for kernel $CUR"
+	echo "(swupd may have overwritten them)"
+	depmod -A "${CUR}"
+fi
-- 
2.37.1

